---
// ARCHIVO: presse.astro - CÓDIGO DEFINITIVO

export const prerender = false
import groq from 'groq'
import { sanity } from '../../lib/sanity'
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getSettings } from '../../lib/getSettings'

const { lang } = Astro.params
const LANGS = new Set(['fr','es','en'])
if (!lang || !LANGS.has(lang)) return Astro.redirect('/fr')

const settings = await getSettings(lang)

// 1. CONSULTA CORREGIDA: Busca "pressItem" y usa 'coalesce' para el fallback
const q = groq`{
  "items": coalesce(
    *[_type=="pressItem" && language==$lang] | order(date desc) {
      title,
      outlet,
      date,
      "slug": slug.current
    },
    *[_type=="pressItem" && language=="fr"] | order(date desc) {
      title,
      outlet,
      date,
      "slug": slug.current
    }
  )
}`
const data = await sanity.fetch(q, { lang })
---

<BaseLayout lang={lang as any} title="Presse" settings={settings}>
  <style>
    main { max-width: 800px; margin: 1.5rem auto; padding: 0 1rem; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 1rem; }
  </style>

  <main>
    <h1>Presse</h1>
    {data.items?.length ? (
      <ul>
        {/* 2. ESTRUCTURA DE LISTA DE ENLACES (como en tu original) */}
        {data.items.map((p) => (
          <li>
            <a href={`/${lang}/presse/${p.slug}`}>{p.title}</a> — {p.outlet} ({new Date(p.date).toLocaleDateString(lang)})
          </li>
        ))}
      </ul>
    ) : (
      <p>Sin notas.</p>
    )}
  </main>
</BaseLayout>